# RHEL 10 Desktop Workstation Bootc Image
FROM registry.redhat.io/rhel10/rhel-bootc:latest

# Enable fips=1 kernel argument: https://bootc-dev.github.io/bootc/building/kernel-arguments.html
COPY 01-fips.toml /usr/lib/bootc/kargs.d/
# Install and enable the FIPS crypto policy
RUN dnf install -y crypto-policies-scripts && update-crypto-policies --no-reload --set FIPS

# Set environment variables
ENV BOOTC_IMAGE=true

# Update system and install base packages
RUN dnf update -y && \
    dnf install -y \
    # Desktop Environment
    @workstation-product-environment \
    # Development tools
    gcc \
    gcc-c++ \
    make \
    cmake \
    git \
    vim \
    nano \
    # Container tools
    podman \
    buildah \
    skopeo \
    # System utilities
    procps-ng \
    tree \
    wget \
    curl \
    rsync \
    unzip \
    tar \
    # Media codecs (if available in repos)
    gstreamer1-plugins-base \
    gstreamer1-plugins-good \
    # Network tools
    NetworkManager-wifi \
    iw \
    # Hardware support
    mesa-dri-drivers \
    # Fonts
    liberation-fonts \
    # Python development
    python3 \
    python3-pip \
    python3-devel \
    # Security tools
    aide \
    audit \
    scap-security-guide \
    openscap-scanner \
    openscap \
    openscap-utils \
    && dnf clean all

# Install additional packages that might be available
RUN dnf install -y \
    gnome-tweaks \
    gnome-extensions-app \
    google-noto-fonts-common \
    || echo "Some optional packages not available, continuing..."

# Create a STIG admin user (since root login will be disabled)
RUN useradd -m -G wheel dots-pa && \
    mkdir -p /var/home/dots-pa/.ssh && \
    chmod 700 /var/home/dots-pa/.ssh && \
    chown dots-pa:dots-pa /var/home/dots-pa/.ssh

RUN dnf -y groupinstall 'Development Tools'

RUN dnf --nogpgcheck -y install https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm && dnf clean all -y
RUN /usr/bin/crb enable

# Set root password
RUN echo 'root:password' | chpasswd

# Enable services
RUN systemctl enable gdm && \
    systemctl enable NetworkManager && \
    systemctl enable bluetooth && \
    systemctl enable cups

# Create a default user (optional - can be done at boot time instead)
# RUN useradd -m -G wheel workstation && \
#     echo "workstation:password" | chpasswd

# Configure sudoers for wheel group
RUN echo "%wheel ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers.d/wheel

# Set up flatpak support
RUN flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

# Configure automatic updates (optional)
RUN dnf install -y dnf-automatic && \
    systemctl enable dnf-automatic.timer

# Create directories and add custom configurations if they exist
RUN umask 022 && mkdir -p /usr/local/bin
RUN chmod 775 /usr/local/bin

# Copy custom scripts if they exist (commented out - uncomment if you have scripts)
COPY --chmod=0755 scripts/apply-stig.sh /usr/local/bin/
#COPY --chmod=0644 config/ /etc/

# Set default target to graphical
RUN systemctl set-default graphical.target

# Bootc specific optimizations
RUN rpm-ostree cleanup -m && \
    ostree container commit

# Copy and install the systemd service
COPY systemd/stig-firstboot.service /etc/systemd/system/
COPY scripts/apply-stig.sh /usr/local/bin/apply-stig.sh
RUN chmod +x /usr/local/bin/apply-stig.sh && \
    systemctl enable stig-firstboot.service

# Labels for the image
LABEL name="rhel10-desktop-workstation" \
      version="1.0" \
      description="RHEL 10 Desktop Workstation with development tools" \
      io.opencontainers.image.title="RHEL 10 Desktop Workstation Bootc" \
      io.opencontainers.image.description="A RHEL 10 based desktop workstation image for bootc" \
      io.opencontainers.image.vendor="Custom Build"

# Set entrypoint (bootc handles this)
# ENTRYPOINT ["/sbin/init"]
